# -*- mode: org -*-
#+OPTIONS: toc:nil

* Installation
** Partitioning

#+begin_src sh
guix shell parted
sudo parted -l

DISK=/dev/nvme0n1
mklabel gpt
mkpart "boot-partition" fat32 0% 1024MiB
set 1 esp on
mkpart primary 1024MiB 100%

mkfs.fat -F32 /dev/nvme0n1p1

cryptsetup luksFormat --type luks2 --pbkdf pbkdf2 /dev/nvme0n1p2

cryptsetup luksOpen /dev/nvme0n1p2 enc

mkfs.btrfs /dev/mapper/enc
mkdir -p /mnt/ssd
mount /dev/mapper/enc /mnt/ssd


cd /mnt/ssd

btrfs subvolume create @
btrfs subvolume create @boot
btrfs subvolume create @home
btrfs subvolume create @gnu
btrfs subvolume create @data
btrfs subvolume create @log
btrfs subvolume create @swap


btrfs subvolume snapshot -r @ blank@

btrfs filesystem mkswapfile --size 32g --uuid clear @swap/swapfile

mount -o subvol=root /dev/mapper/enc /mnt
mkdir {boot,boot/efi,home,gnu,var/log,swap}

herd start cow-store /mnt

export TMPDIR=/mnt/data/install/tmp
mkdir -p $TMPDIR

#+end_src

* Enable non-guix channel
** Channel file
Copy the following channel file to the root ~/.config/guix 
#+begin_src guile
(list (channel
         (name 'nonguix)
         (url "https://gitlab.com/nonguix/nonguix"))
        (channel
         (name 'guix)
         (url "https://git.savannah.gnu.org/git/guix.git")
         ;; (url "file:///home/daviwil/Projects/Code/guix"))
         (introduction
          (make-channel-introduction
           "9edb3f66fd807b096b48283debdcddccfea34bad"
           (openpgp-fingerprint
            "BBB0 2DDF 2CEA F6A8 0D1D  E643 A2A0 6DF2 A33A 54FA")))))
#+end_src
To update the system to use the non-guix channel:
#+begin_src sh
guix pull
guix hash # To ensure the channel is in use

#+end_src

* Install the system
#+begin_src
guix shell git
git clone https://github.com/paul-jewell/dotfiles.git
cd dotfiles
guix system  -L . init paulj/systems/${HOSTNAME}.scm /mnt
#+end_src

